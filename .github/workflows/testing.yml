name: Testing the action

on: 
  push:

  workflow_dispatch:

env:
  organization: devops-actions
  repo: load-runner-info

jobs:
  build: # make sure build/ci work properly
    runs-on: ubuntu-latest
    #if: github.ref == 'refs/heads/main' # don't run on PRs
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - run: npm run all

  test-from-organization:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        id: load-runner-info-org
        with: 
          accessToken: ${{ secrets.PAT }}
          organization: ${{ env.organization }}

      - name: Store output in result file
        run: echo '${{ steps.load-runner-info-org.outputs.runners }}' > 'runners-organization.json'
            
      - name: Upload result file as artefact
        uses: actions/upload-artifact@v2
        with: 
          name: runners-organization-${{ env.organization }}
          path: runners-organization.json

      - uses: actions/github-script@v5
        with: 
          script: |
            const info = JSON.parse(`${{ steps.load-runner-info-org.outputs.runners }}`)
            if (info.length == 0) {
              core.error('No runners found')            
              return
            }

            for (let num = 0; num < info.runners.length; num++) {
              const runner = info.runners[num]
              console.log(runner.name)
            }